{
	"info": {
		"_postman_id": "order-management-test-001",
		"name": "Order Management Test Collection",
		"description": "Complete Postman collection for testing order management endpoints including user orders, order details, cancel order, and business accept/reject",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Authentication",
			"item": [
				{
					"name": "User Login",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data && response.data.token) {",
									"        pm.environment.set(\"userToken\", response.data.token);",
									"        pm.environment.set(\"userId\", response.data.user.id);",
									"        console.log(\"User token saved:\", response.data.token);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"auth",
								"login"
							]
						},
						"description": "Login as user to get authentication token"
					},
					"response": []
				},
				{
					"name": "Business Login",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data && response.data.token) {",
									"        pm.environment.set(\"businessToken\", response.data.token);",
									"        pm.environment.set(\"businessId\", response.data.business.id);",
									"        console.log(\"Business token saved:\", response.data.token);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"business@example.com\",\n  \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/business/login",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"business",
								"login"
							]
						},
						"description": "Login as business to get authentication token"
					},
					"response": []
				}
			],
			"description": "Authentication endpoints to get tokens"
		},
		{
			"name": "2. Get Business Orders (to get orderId)",
			"item": [
				{
					"name": "Get Business Orders",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data && response.data.orders && response.data.orders.length > 0) {",
									"        const firstOrder = response.data.orders[0];",
									"        pm.environment.set(\"orderId\", firstOrder.id);",
									"        pm.environment.set(\"orderNumber\", firstOrder.order_number || \"\");",
									"        console.log(\"Order ID saved:\", firstOrder.id);",
									"        console.log(\"Order Status:\", firstOrder.status);",
									"    } else {",
									"        console.log(\"No orders found. Create an order first.\");",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{businessToken}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/business/orders?page=1&limit=10",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"business",
								"orders"
							],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "limit",
									"value": "10"
								}
							]
						},
						"description": "Get all orders for the business. This will set the orderId environment variable for subsequent requests."
					},
					"response": []
				}
			],
			"description": "Get business orders to retrieve an orderId for testing"
		},
		{
			"name": "3. User Order Endpoints",
			"item": [
				{
					"name": "Get User Orders",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has success field\", function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success');",
									"});",
									"",
									"pm.test(\"Response has orders array\", function () {",
									"    const response = pm.response.json();",
									"    if (response.success) {",
									"        pm.expect(response.data).to.have.property('orders');",
									"        pm.expect(response.data.orders).to.be.an('array');",
									"        ",
									"        // Save first order ID if available",
									"        if (response.data.orders.length > 0) {",
									"            pm.environment.set(\"orderId\", response.data.orders[0].id);",
									"        }",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{userToken}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/orders/user?page=1&limit=10",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"orders",
								"user"
							],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "limit",
									"value": "10"
								},
								{
									"key": "status",
									"value": "pending",
									"description": "Optional: pending, accepted, preparing, waiting_driver, in_delivery, completed, cancelled",
									"disabled": true
								}
							]
						},
						"description": "Get all orders for the logged-in user. This endpoint should work without UUID validation error."
					},
					"response": []
				},
				{
					"name": "Get Order Details",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has order details\", function () {",
									"    const response = pm.response.json();",
									"    if (response.success) {",
									"        pm.expect(response.data).to.have.property('order');",
									"        pm.expect(response.data.order).to.have.property('id');",
									"        pm.expect(response.data.order).to.have.property('order_number');",
									"        ",
									"        // Check business info exists (without phone field error)",
									"        if (response.data.order.business) {",
									"            pm.expect(response.data.order.business).to.have.property('id');",
									"            pm.expect(response.data.order.business).to.have.property('business_name');",
									"            console.log(\"Business info retrieved successfully\");",
									"        }",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{userToken}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/orders/{{orderId}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"orders",
								"{{orderId}}"
							]
						},
						"description": "Get detailed information about a specific order. Should return order with business info (no phone field error)."
					},
					"response": []
				},
				{
					"name": "Cancel Order",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 400\", function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
									"});",
									"",
									"pm.test(\"Response has success field\", function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success');",
									"});",
									"",
									"if (pm.response.code === 200) {",
									"    pm.test(\"Order cancelled successfully\", function () {",
									"        const response = pm.response.json();",
									"        pm.expect(response.success).to.be.true;",
									"    });",
									"} else if (pm.response.code === 400) {",
									"    console.log(\"Order cannot be cancelled (may already be in progress)\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{userToken}}",
									"type": "string"
								}
							]
						},
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/orders/{{orderId}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"orders",
								"{{orderId}}"
							]
						},
						"description": "Cancel an order. Only works for pending or accepted orders. Uses Prisma syntax (fixed)."
					},
					"response": []
				}
			],
			"description": "User-side order management endpoints"
		},
		{
			"name": "4. Business Order Management",
			"item": [
				{
					"name": "Accept Order",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Order accepted successfully\", function () {",
									"    const response = pm.response.json();",
									"    if (response.success) {",
									"        pm.expect(response.message).to.include('accepted');",
									"        console.log(\"Order accepted successfully\");",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{businessToken}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/business/orders/{{orderId}}/accept",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"business",
								"orders",
								"{{orderId}}",
								"accept"
							]
						},
						"description": "Accept a pending order. Business can accept orders assigned to them."
					},
					"response": []
				},
				{
					"name": "Reject Order",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Order rejected successfully\", function () {",
									"    const response = pm.response.json();",
									"    if (response.success) {",
									"        pm.expect(response.message).to.include('rejected');",
									"        console.log(\"Order rejected successfully\");",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{businessToken}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"reason\": \"Out of stock\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/business/orders/{{orderId}}/reject",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"business",
								"orders",
								"{{orderId}}",
								"reject"
							]
						},
						"description": "Reject a pending order. Business can reject orders with a reason."
					},
					"response": []
				}
			],
			"description": "Business-side order management endpoints (accept/reject)"
		},
		{
			"name": "5. Create Order (for testing)",
			"item": [
				{
					"name": "Get Business Products",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data && response.data.products && response.data.products.length > 0) {",
									"        const firstProduct = response.data.products[0];",
									"        pm.environment.set(\"productId\", firstProduct.id);",
									"        console.log(\"Product ID saved:\", firstProduct.id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/business/{{businessId}}/products",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"business",
								"{{businessId}}",
								"products"
							]
						},
						"description": "Get products from a business to use for creating an order"
					},
					"response": []
				},
				{
					"name": "Create Order",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data && response.data.order) {",
									"        pm.environment.set(\"orderId\", response.data.order.id);",
									"        pm.environment.set(\"orderNumber\", response.data.order.order_number || \"\");",
									"        console.log(\"Order created. Order ID:\", response.data.order.id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{userToken}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"items\": [\n    {\n      \"product_id\": \"{{productId}}\",\n      \"quantity\": 2\n    }\n  ],\n  \"order_type\": \"delivery\",\n  \"payment_method\": \"cash\",\n  \"delivery_address\": {\n    \"street\": \"123 Test Street\",\n    \"city\": \"Cairo\",\n    \"latitude\": 30.0444,\n    \"longitude\": 31.2357\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/orders",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"orders"
							]
						},
						"description": "Create a new order for testing purposes"
					},
					"response": []
				}
			],
			"description": "Helper endpoints to create orders for testing"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Set base URL if not already set",
					"if (!pm.environment.get(\"base_url\")) {",
					"    pm.environment.set(\"base_url\", \"https://csy-backend-production.up.railway.app\");",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "https://csy-backend-production.up.railway.app",
			"type": "string"
		}
	]
}

